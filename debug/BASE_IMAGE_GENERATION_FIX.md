# Base Image Generation Fix

## Problem Identified
The base image generation was creating a simplified request format instead of a fully-fledged ComfyUI workflow request to RunPod serverless.

**Before (Incorrect):**
```json
{
  "actorName": "0039_asian_21_female",
  "description": "A 21 year old asian woman...",
  "width": 1024,
  "height": 1536,
  "steps": 25,
  "seed": -1
}
```

**After (Correct):**
```json
{
  "payload": {
    "input": {
      "workflow": {
        "1": { "inputs": { ... }, "class_type": "UNETLoader" },
        "2": { "inputs": { ... }, "class_type": "VAELoader" },
        // ... complete ComfyUI workflow
      },
      "model_urls": [],
      "force_download": false
    }
  },
  "mode": "text-to-image"
}
```

## Changes Made

### 1. Updated `scripts/generate_base_image.py`
- Changed payload structure to match `generation_request.json` format
- Added nested `payload.input` structure with `workflow`, `model_urls`, and `force_download`
- Added `mode: "text-to-image"` at root level
- Added debug logging to save full payload to `debug/base_image_full_payload.json`

### 2. Updated `ui/config/routes/base-image-api.ts`
- Updated logging to clarify that input parameters are saved separately
- Added note that full ComfyUI workflow is generated by Python script

## How It Works Now

1. **Frontend** sends simple parameters (actorName, description, dimensions, etc.)
2. **Python script** (`generate_base_image.py`):
   - Builds full ComfyUI workflow using `WorkflowBuilder`
   - Creates complete RunPod serverless request with proper structure
   - Saves full payload to `debug/base_image_full_payload.json`
   - Sends request to RunPod serverless endpoint
   - **Recursively searches** for images array in response (handles any nesting)
   - Extracts first base64 image and returns in clean format
3. **RunPod** processes the complete workflow and returns generated image

## Debug Files Generated

- `debug/base_image_request.json` - Input parameters from frontend
- `debug/base_image_full_payload.json` - Complete RunPod payload with workflow
- `debug/base_image_response.json` - Response from RunPod
- `debug/base_image_result.jpg` - Generated image (if successful)

## Verification

The full payload structure now matches the format used in successful image generation requests, with:
- Complete ComfyUI workflow with all nodes (UNETLoader, VAELoader, CLIPTextEncode, etc.)
- Proper node connections and parameters
- LoRA stack configuration (empty for base images)
- All required workflow metadata

This ensures base image generation uses the same robust workflow system as regular image generation.

## Response Parsing Fix

The script now includes a `find_images_in_response()` helper function that:
- **Recursively searches** through the entire response object for an `images` array
- Handles any level of nesting (e.g., `output.output.images`, `output.job_results.images`, etc.)
- Extracts the first base64 image string
- Returns a clean, normalized response structure that matches what the TypeScript `extractImageUrl()` function expects

This makes the system resilient to changes in RunPod's response format and ensures images are always found regardless of nesting depth.

## CLIP Connection Fix (Critical)

**Problem**: Base image generation was failing with error:
```
ERROR: clip input is invalid: None
node=6; node_type=CLIPTextEncode
```

**Root Cause**: 
- Node 6 (CLIPTextEncode) was always connected to node 40 (Easy Apply LoraStack) for CLIP input
- When there are NO LoRAs, the LoRA stack has `toggle: false` and doesn't output valid CLIP
- This caused node 6 to receive `None` as CLIP input, breaking the workflow

**Solution**: 
The workflow builder now dynamically adjusts the CLIP connection based on LoRA status:
- **No LoRAs** (`toggle: false`): Node 6 connects directly to node 3 (DualCLIPLoader)
- **With LoRAs** (`toggle: true`): Node 6 connects through node 40 (LoRA stack)

This ensures base images (which have no LoRAs) work correctly while maintaining compatibility with LoRA-based generation.
